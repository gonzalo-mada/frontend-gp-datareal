<p-table
    #dt
    [value]="data" 
    [dataKey]="dataKeyTable" 
    [rows]="10" 
    [paginator]="true" 
    [rowsPerPageOptions]="[10,25,50]" 
    [showCurrentPageReport]="true"
    [globalFilterFields]="globalFiltros"
    [customSort]="true"
    (sortFunction)="customSort($event)"
    sortField="fecha" [sortOrder]="-1"
    currentPageReportTemplate="{first} hasta {last} de {totalRecords} actividades."
    autoLayout="true"
>
    <ng-template pTemplate="caption">
        <div class="flex align-items-center justify-content-between">
            <div class="flex mb-2 md:mb-0">
                <span class="p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" placeholder="Buscar..." [(ngModel)]="searchValue" (input)="onGlobalFilter(dt, $event)" />
                    </span>
                <!-- <p-button
                    (onClick)="showFilters = !showFilters"
                    [label]="showFilters ? 'Ocultar filtros' : 'Ver más filtros' " 
                    [icon]="showFilters ? 'pi pi-eye-slash' : 'pi pi-eye' " 
                    styleClass="ml-2" 
                    iconPos="right" 
                /> -->
                <p-button 
                    styleClass="p-button-text ml-2" 
                    icon="pi pi-filter-slash" 
                    pTooltip="Limpiar filtros"
                    tooltipPosition="bottom" 
                    (click)="clear(dt)">
                </p-button>
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="header">
        <tr>
            <th pSortableColumn="descripcion.descripcion" style="width:35%;">
                <div class="flex justify-content-start align-items-center">
                    Actividad
                    <p-sortIcon field="descripcion.descripcion" />
                    <p-columnFilter
                        [showMatchModes]="false" 
                        [showOperator]="false" 
                        [showAddButton]="false"
                        [showButtons]="false"
                        field="descripcion.descripcion" 
                        matchMode="in" 
                        display="menu"
                    >
                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                            <p-multiSelect 
                                [options]="groupedData.actividades" 
                                [group]="true" 
                                [ngModel]="value"
                                [maxSelectedLabels]="2"
                                (onChange)="filter($event.value); countTableValues(dt)"
                                appendTo="body" 
                                placeholder="Filtrar por actividad" 
                                selectedItemsLabel="{0} actividades seleccionadas"
                            >
                                <ng-template let-group pTemplate="group">
                                    <div class="flex align-items-center">
                                        <span>{{ group.label }}</span>
                                    </div>
                                </ng-template>
                            </p-multiSelect>
                        </ng-template>
                    </p-columnFilter> 
                </div>
            </th>
            <th pSortableColumn="tipo_movimiento" style="width:15%;">
                <div class="flex justify-content-start align-items-center">
                    Tipo de actividad 
                    <p-sortIcon field="tipo_movimiento" /> 
                    <p-columnFilter
                        [showMatchModes]="false" 
                        [showOperator]="false" 
                        [showAddButton]="false"
                        [showButtons]="false"
                        field="tipo_movimiento" 
                        matchMode="in" 
                        display="menu"
                    >
                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                            <p-multiSelect 
                                [options]="groupedData.tipos_actividades" 
                                [ngModel]="value"
                                [maxSelectedLabels]="2"
                                (onChange)="filter($event.value); countTableValues(dt)"
                                appendTo="body" 
                                placeholder="Filtrar por tipo de actividad" 
                                selectedItemsLabel="{0} tipos de actividades seleccionadas"
                            >
                            </p-multiSelect>
                        </ng-template>
                    </p-columnFilter>
                </div>
            </th>
            <th pSortableColumn="fecha" style="width:15%;">
                <div class="flex justify-content-start align-items-center">
                    Fecha 
                    <p-sortIcon field="fecha" /> 
                    <p-columnFilter
                        #f 
                        [showMatchModes]="false" 
                        [showOperator]="false" 
                        [showAddButton]="false"
                        [showButtons]="false"
                        field="fecha" 
                        display="menu" 
                    >
                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                            <p-calendar 
                                [(ngModel)]="selectedDate" 
                                [hideOnDateTimeSelect]="false" 
                                [readonlyInput]="true"
                                (onSelect)="filter(selectedDate); countTableValues(dt)"
                                placeholder="Filtre por fecha" 
                                appendTo="body" 
                                dataType="string" 
                                dateFormat="dd-mm-yy" 
                            >
                                <ng-template pTemplate="footer">
                                    <div class="flex justify-content-center flex-wrap mb-2">
                                        <p-button 
                                            styleClass="p-button-sm p-button-text" 
                                            icon="pi pi-times" 
                                            pTooltip="Cerrar"
                                            (click)="f.hide()">
                                        </p-button>
                                    </div>
                                    
                                </ng-template>
                            </p-calendar>
                        </ng-template>
                    </p-columnFilter>
                </div>

            </th>
            <th pSortableColumn="nombre_usuario" style="width:25%;">
                <div class="flex justify-content-start align-items-center">
                    Realizada por 
                    <p-sortIcon field="nombre_usuario" /> 
                    <p-columnFilter 
                        [showMatchModes]="false" 
                        [showOperator]="false" 
                        [showAddButton]="false"
                        [showButtons]="false"
                        field="nombre_usuario" 
                        matchMode="in" 
                        display="menu"
                        appendTo="body"
                    >
                        <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                            <p-multiSelect
                                [options]="groupedData.usuarios" 
                                [ngModel]="value"
                                [maxSelectedLabels]="1"
                                (onChange)="filter($event.value); countTableValues(dt)" 
                                appendTo="body" 
                                placeholder="Filtrar por usuario"
                                selectedItemsLabel="{0} usuarios seleccionados" 
                            >
                            </p-multiSelect>
                        </ng-template>
                    </p-columnFilter>
                </div>
            </th>
            <th style="width:5%;">Acción</th>
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-data>
        <tr>
            <td>
                <ng-container *ngIf="data.descripcion.descripcion.includes('DOCUMENTOS'); else notDocuments">
                    <span> {{data.descripcion.descripcion}} <br> </span>
                    <span *ngIf="data.descripcion.valor_despues !== null " style="font-size: 0.8rem;"> 
                        <strong>DOCUMENTOS:</strong> {{data.descripcion.valor_despues | slice:0:100}} {{ (data.descripcion.valor_despues.length > 50 ) ? '...' : '' }}
                    </span>
                </ng-container>
                <ng-template #notDocuments>
                    <span> {{data.descripcion.descripcion}} <br> </span>
                    <span *ngIf="data.descripcion.valor_antes !== null " style="font-size: 0.8rem;"> <strong>ANTES:</strong> {{data.descripcion.valor_antes | slice:0:45}} {{ (data.descripcion.valor_antes.length > 45 ) ? '...' : '' }}<br></span>
                    <span *ngIf="data.descripcion.valor_despues !== null " style="font-size: 0.8rem;"> <strong>AHORA:</strong> {{data.descripcion.valor_despues | slice:0:45}} {{ (data.descripcion.valor_despues.length > 45 ) ? '...' : '' }}</span>
                </ng-template>

            </td>
            <td>
                <ng-container [ngSwitch]="data.tipo_movimiento">
                    <ng-container *ngSwitchCase="'C'">
                        <span>Creación de {{ form }}</span>
                    </ng-container>
                    <ng-container *ngSwitchCase="'U'">
                        <span>Actualización en el {{ form }} </span>
                    </ng-container>
                    <ng-container *ngSwitchCase="'D'">
                        <span>Eliminación en el {{ form }} </span>
                    </ng-container>
                </ng-container>

            </td>
            <td>
                {{data.fecha_hora}}
            </td>
            <td>
                <span> {{data.nombre_usuario}}  <br> </span>
                <span style="font-size: 0.8rem;">
                    <strong>RUT:</strong> {{data.usuario}}<br>
                    <strong>Correo:</strong> {{data.correo_usuario}}<br>
                </span>
            </td>
            <td>
                <div class="flex align-items-center justify-content-center">
                    <p-button 
                        icon="pi pi-eye" 
                        styleClass="p-button-sm p-button-info mr-2" 
                        pTooltip="Ver registro"
                        (click)="show(data)" 
                        tooltipPosition="left"
                    >
                    </p-button>
                </div>
            </td>
        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td [attr.colspan]="4">Sin registros</td>
        </tr>
    </ng-template>

</p-table>

<app-dialog *ngIf="dialog" [(visible)]="dialog">
    <div header>
        <span class="text-xl">Ver actividad</span>
    </div>
    <div content>
        <div class="formgrid grid">
            <div class="col-12 sm:col-4 mb-3">
                <div class="flex flex-column">
                    <span class="text-900"> <strong>Tipo de actividad</strong> </span>
                    <span *ngIf="actividad.tipo_movimiento === 'C' " class="text-700"> Creación de {{ form }} </span>
                    <span *ngIf="actividad.tipo_movimiento === 'U' " class="text-700"> Actualización en el {{ form }} </span>
                    <span *ngIf="actividad.tipo_movimiento === 'D' " class="text-700"> Eliminación en el {{ form }} </span>
                </div>
            </div>

            <div class="col-12 sm:col-4 mb-3">
                <div class="flex flex-column">
                    <span class="text-900"> <strong>Realizada por</strong> </span>
                    <span class="text-700"> {{actividad.nombre_usuario}}  <br> </span>
                    <span class="text-700" style="font-size: 0.8rem;">
                        <strong>RUT:</strong> {{actividad.usuario}}<br>
                        <strong>Correo:</strong> {{actividad.correo_usuario}}<br>
                    </span>
                </div>
            </div>

            <div class="col-12 sm:col-4 mb-3">
                <div class="flex flex-column">
                    <span class="text-900"> <strong>Fecha</strong> </span>
                    <span class="text-700"> {{actividad.fecha_hora}} </span>
                </div>
            </div>

            <div class="col-12 sm:col-4 mb-3">
                <div class="flex flex-column">
                    <span class="text-900"> <strong>Actividad</strong> </span>
                    <span class="text-700"> {{actividad.descripcion?.descripcion}} </span>
                </div>
            </div>

            <div class="col-12 sm:col-4 mb-3">
                <div *ngIf="needValorAntes(actividad)" class="flex flex-column">
                    <span class="text-900"> <strong>Antes</strong> </span>
                    <span class="text-700"> {{actividad.descripcion?.valor_antes }} </span>
                </div>
            </div>

            <div class="col-12 sm:col-4 mb-3">
                <div *ngIf="needValorDespues(actividad)" class="flex flex-column">
                    <span class="text-900"> <strong>Ahora</strong> </span>
                    <span class="text-700"> {{actividad.descripcion?.valor_despues }} </span>
                </div>
            </div>
        </div>
        <div class="grid" *ngIf="needTable(actividad)">
            <div class="col-12">
                <p-table [value]="actividad.arrayData" [tableStyle]="{ 'min-width': '50rem' }" styleClass="p-datatable-sm w-full">
                    <ng-template pTemplate="header">
                        <tr>
                            <th> {{ fromMultiSelect ? 'Antes' : 'Documentos' }} </th>
                            <th *ngIf="fromMultiSelect"> Ahora </th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-data>
                        <tr>
                            <td *ngIf="!fromMultiSelect">{{ data }}</td>
                            <td *ngIf="fromMultiSelect">{{ data.antes }}</td>
                            <td *ngIf="fromMultiSelect">{{ data.despues }}</td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </div>
    <div footer>
        <p-button label="Cerrar" icon="pi pi-times" styleClass="p-button-sm p-button-secondary mr-2"
        (click)="dialog = false" [text]="true">
    </p-button>
    </div>
</app-dialog>
