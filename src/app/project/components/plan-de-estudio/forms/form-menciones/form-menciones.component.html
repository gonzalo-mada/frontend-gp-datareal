<app-dialog [dialogWidth]="'85vw'" [(visible)]="main.dialogForm">
    <div header>
        <ng-container *ngIf="(main.modeForm === 'create' || main.modeForm === 'insert') && (main.openedFrom !== 'crud_asign' && main.openedFrom !== 'crud_pe' ) ">
            <span class="text-xl">Agregar {{ main.namesCrud.singular }}</span>
        </ng-container>
        <ng-container *ngIf="main.modeForm === 'edit' || main.modeForm === 'update' ">
            <span class="text-xl">Actualizar {{ main.namesCrud.singular }}</span>
        </ng-container>
        <ng-container *ngIf="main.modeForm === 'show'">
            <span class="text-xl">Visualizar {{ main.namesCrud.singular }}</span>
        </ng-container>
        <ng-container *ngIf=" (main.modeForm === 'create' || main.modeForm === 'insert') &&  main.openedFrom === 'crud_asign'">
            <span class="text-xl">Incluir {{ main.namesCrud.singular }} </span>
        </ng-container>
    </div>
    
    <div content>
        <!-- <p-button 
            label="test" 
            icon="pi pi-times" 
            styleClass="p-button-sm p-button-secondary mr-2" 
            (click)="test()" [text]="true">
        </p-button>   -->

        <div class="grid" *ngIf="main.modeForm !== 'show' ">
            <div class="col-12">
                <app-form-isvalid [valid]="form.fbForm.valid"></app-form-isvalid>
            </div>
        </div>

        <div class="mt-2">
            <p-messages [(value)]="main.messagesFormulario" [enableService]="false" />
        </div>
        
        <div class="grid">
            <div class="col-2 p-1">
                <div class="flex flex-column gap-2 w-full border-right">
                    <button
                        *ngIf="main.openedFrom !== 'crud_asign' || main.modeForm === 'show'" 
                        pButton 
                        class="p-button-text flex align-items-center justify-content-between" 
                        (click)="form.activeTab = 0" 
                        [ngClass]="{'p-highlight': form.activeTab === 0}" 
                        [disabled]="form.activeTab < 0">
                        Mención
                        <i *ngIf="form.stateStepOne" class="pi pi-check text-green-500 ml-2"></i>
                    </button>
                  
                    <button
                        *ngIf="(needShowAsignaturas && main.openedFrom !== 'crud_asign') || main.modeForm === 'show'" 
                        pButton 
                        class="p-button-text flex align-items-center justify-content-between" 
                        (click)="form.activeTab = 1" 
                        [ngClass]="{'p-highlight': form.activeTab === 1}" 
                        [disabled]="!form.stateStepOne">
                        Asignaturas
                        <i *ngIf="form.stateStepTwo" class="pi pi-check text-green-500 ml-2"></i>
                    </button>
                                
                    <button
                        *ngIf="main.openedFrom !== 'crud_asign' || main.modeForm === 'show'" 
                        pButton 
                        class="p-button-text flex align-items-center justify-content-between" 
                        (click)="form.activeTab = 2" 
                        [ngClass]="{'p-highlight': form.activeTab === 2}" 
                        [disabled]="!form.stateStepTwo && main.modeForm !== 'show'">
                        Documentos
                        <i *ngIf="form.fbForm.get('files')!.valid || main.modeForm === 'show'" class="pi pi-check text-green-500 ml-2"></i>
                    </button>
        
                    <button
                        *ngIf="main.openedFrom === 'crud_asign' && main.modeForm === 'create'" 
                        pButton 
                        class="p-button-text flex align-items-center justify-content-between" 
                        (click)="form.activeTab = 4" 
                        [ngClass]="{'p-highlight': form.activeTab === 4}" 
                        [disabled]="!form.stateStepTwo">
                        Incluir mención a asignatura(s)
                        <i *ngIf="form.stateForm === 'VALID'" class="pi pi-check text-green-500 ml-2"></i>
                    </button>
                </div>
            </div>
              
            <div class="col-10 p-1">

                <p-panel header="Mención" *ngIf="form.activeTab === 0">
                    <form [formGroup]="form.fbForm">
                        <div class="formgrid grid">

                            <div class="field col-12 md:col-4">
                                <label><strong>Facultad {{ main.modeForm === 'show' ? '' : '*'}} </strong></label>
                                <p-dropdown 
                                    [options]="mainFacultades.facultades"
                                    formControlName="cod_facultad"
                                    optionLabel="Descripcion_facu"
                                    optionValue="Cod_facultad" 
                                    placeholder="Seleccione facultad"
                                    appendTo="body" 
                                    styleClass="w-full p-d-flex p-flex-column" 
                                    (onChange)="changeFacultad($event)" 
                                />
                            </div>

                            <div class="field col-12 md:col-4">
                                <label><strong>Programas {{ main.modeForm === 'show' ? '' : '*'}} </strong></label>
                                <p-dropdown 
                                    [options]="main.programas"
                                    formControlName="cod_programa"
                                    optionLabel="Nombre_programa_completo"
                                    optionValue="Cod_Programa" 
                                    placeholder="Seleccione programa de postgrado"
                                    appendTo="body" 
                                    styleClass="w-full p-d-flex p-flex-column" 
                                    (onChange)="changeProgramaPostgrado($event)" 
                                />
                            </div>

                            <div class="field col-12 md:col-4">
                                <label><strong>Plan de estudio {{ main.modeForm === 'show' ? '' : '*'}} </strong></label>
                                <p-dropdown 
                                    [options]="main.planes"
                                    formControlName="cod_plan_estudio"
                                    optionLabel="nombre_plan_estudio_completo"
                                    optionValue="cod_plan_estudio" 
                                    placeholder="Seleccione plan de estudio"
                                    appendTo="body" 
                                    styleClass="w-full p-d-flex p-flex-column" 
                                    (onChange)="changePlanDeEstudio($event)" 
                                />
                            </div>

                            <div class="field col-12 md:col-6">
                                <label><strong>Nombre {{ main.modeForm === 'show' ? '' : '*'}} </strong></label>
                                <input type="text" pInputText formControlName="nombre_mencion" maxlength="50" class="w-full" placeholder="Ingrese nombre de la mención" />
                                <app-form-control [control]="form.fbForm.controls['nombre_mencion']" [validators]="['required', 'num_y_letras']"></app-form-control>
                            </div>
            
                            <div class="field col-12 md:col-6">
                                <label><strong>Descripción {{ main.modeForm === 'show' ? '' : '*'}} </strong></label>
                                <input type="text" pInputText formControlName="descripcion_mencion" maxlength="50" class="w-full" placeholder="Ingrese descripción de la mención" />
                                <app-form-control [control]="form.fbForm.controls['descripcion_mencion']" [validators]="['required', 'num_y_letras']"></app-form-control>
                            </div>
            
                            <div class="field col-12 md:col-4">
                                <label><strong>¿Está vigente? {{ main.modeForm === 'show' ? '' : '*'}} </strong></label>
                                <div class="flex flex-row flex-wrap">
                                    <div class="flex align-items-center justify-content-center">
                                        <span>No</span>
                                    </div>
                                    <div class="flex align-items-center justify-content-center mx-2">
                                        <p-inputSwitch formControlName="vigencia" styleClass="mt-1"></p-inputSwitch>
                                    </div>
                                    <div class="flex align-items-center justify-content-center">
                                        <span>Si</span>
            
                                    </div>
                                </div>
                                <app-form-control [control]="form.fbForm.controls['vigencia']" [validators]="['required']"></app-form-control>
                            </div>
            
                            <div class="field col-12 md:col-4">
                                <label><strong>N° REXE {{ main.modeForm === 'show' ? '' : '*'}} </strong></label>
                                <input type="text" pInputText formControlName="mencion_rexe" maxlength="50" class="w-full" placeholder="Ingrese N° REXE de la mención" />
                                <app-form-control [control]="form.fbForm.controls['mencion_rexe']" [validators]="['required', 'num_y_letras']"></app-form-control>
                            </div>
            
                            <div class="field col-12 md:col-4">
                                <div class="flex flex-wrap">
                                    <div class="w-full">
                                        <div class="mb-2">
                                            <label><strong>Fecha de creación {{ main.modeForm !== 'show' ? '*' : '' }}</strong></label>
                                        </div>
                                        <p-calendar
                                            formControlName="fecha_creacion"
                                            dateFormat="dd-mm-yy"
                                            placeholder="Seleccione fecha de creación"
                                            [monthNavigator]="true" [yearNavigator]="true"
                                            class="w-full p-d-flex p-flex-column"
                                            readonlyInput="true"
                                            appendTo="body"
                                            autofocus="false"
                                            [style]="{ width: '100%', 'min-width': '100%' }"
                                            dataType="string"
                                        ></p-calendar>
                                        <app-form-control [control]="form.fbForm.controls['fecha_creacion']" [validators]="['required']"></app-form-control>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="flex justify-content-end mt-3">
                        <button pButton label="Siguiente" icon="pi pi-arrow-right" iconPos="right" (click)="nextStep()" [disabled]="!form.stateStepOne"></button>
                    </div>
                </p-panel>

                <p-panel header="Asignaturas" *ngIf="form.activeTab === 1 && needShowAsignaturas">
                    <form [formGroup]="form.fbForm">
                        <div class="formgrid grid">
                            <div class="field col-12">
                                <div class="flex flex-column sm:flex-row align-items-center justify-content-center border-round">
                                    <div class="w-full sm:w-auto">
                                        <p-messages  [(value)]="form.messages" [enableService]="false" [escape]="false" />
                                    </div>
                                </div>
                                <label><strong>{{ main.modeForm === 'show' ? 'Asignaturas seleccionadas' : 'Seleccione asignatura *'}}</strong></label>

                                <p-treeTable
                                    #dt2    
                                    [value]="main.asignaturas"
                                    [columns]="table.cols_asignatura"
                                    [globalFilterFields]="['nombre_asignatura_completa']"
                                    [scrollable]="true"
                                    [rowHover]="true"
                                    selectionMode="checkbox"
                                    scrollHeight="350px"
                                    dataKey="key"
                                    [(selectionKeys)]="table.selectedAsignaturaRows" 
                                    (selectionKeysChange)="selectAsignatura($event)"
            
                                >
                                    <ng-template pTemplate="caption">
                                        <div class="flex flex-wrap flex-column sm:flex-row justify-content-between align-items-center">
                                            <div class="flex flex-row flex-wrap align-items-center">
                                                <p-button
                                                    *ngIf="form.fbForm.get('asignaturas')?.value.length !== 0 && main.modeForm !== 'show'"
                                                    label="Deseleccionar ({{ form.fbForm.get('asignaturas')?.value.length }})"
                                                    icon="pi pi-times"
                                                    styleClass="p-button-danger p-button-outlined"
                                                    (click)="clearTableAsignatura(); dt2.toggleNodesWithCheckbox($event, false)"
                                                ></p-button>
                                                <div class="flex m-1">
                                                    <span class="p-input-icon-left">
                                                    <i class="pi pi-search"></i>
                                                    <input #inputAsignatura pInputText type="text" placeholder="Buscar..." (input)="dt2.filterGlobal($any($event.target).value, 'contains')" />
                                                    </span>
                                                </div>
                                                <p-button 
                                                    styleClass="p-button-text p-button-sm " 
                                                    icon="pi pi-filter-slash" 
                                                    pTooltip="Limpiar filtros" 
                                                    (click)="inputAsignatura.value = ''; dt2.filterGlobal('', 'contains') ">
                                                </p-button>
                                            </div>
                                            <div class="flex estado-badge-doc icon-leyenda" pTooltip="Leyenda de iconos" tooltipPosition="bottom">
                                                <span class="icon-badge"><i class="pi pi-chevron-right"></i></span>
                                                <span class="mx-1 font-light">ver temas</span>
                                            </div>
                                        </div>
                                    </ng-template>
            
                                    <ng-template pTemplate="header" let-columns>
                                        <tr>
                                            <th style="width: 2rem"></th>
                                            <th style="width: 2rem"></th>
                                            <th *ngFor="let col of columns">
                                                {{ col.header }}
                                            </th>
                                        </tr>
                                    </ng-template>
            
                                    <ng-template pTemplate="body" let-rowNode let-rowData="rowData" let-columns="columns">
                                        <tr [ttRow]="rowNode" [ttSelectableRow]="rowNode">
                                            <td *ngFor="let col of columns; let i = index">
                                                <p-treeTableToggler [rowNode]="rowNode" *ngIf="i === 0" />
                                                <p-treeTableCheckbox [disabled]="main.modeForm === 'show'" [value]="rowNode" *ngIf="i === 0" />
                                                <span class="truncate" style="font-size: 0.8rem;">
                                                    {{ rowData[col.field] }}
                                                </span>
                                            </td>
                                        </tr>
                                    </ng-template>
            
                                    <ng-template pTemplate="emptymessage">
                                        <tr>
                                            <td [attr.colspan]="2">Sin registros</td>
                                        </tr>
                                    </ng-template>
                                    
                                </p-treeTable>
                            </div>
                        </div>
                    </form>
                    <div class="flex justify-content-between mt-3">
                        <button pButton label="Atrás" icon="pi pi-arrow-left" (click)="prevStep()"></button>
                        <button pButton label="Siguiente" icon="pi pi-arrow-right" iconPos="right" (click)="nextStep()" [disabled]="!form.stateStepTwo"></button>
                    </div>
                </p-panel>

                <p-panel header="Documentos" *ngIf="form.activeTab === 2">
                    <form [formGroup]="form.fbForm">
                        <div class="formgrid grid">
                            <div class="field col-12">
                                <label><strong>{{ main.modeForm === 'show' ? 'Documento(s) adjunto(s)' : 'Adjunte documento(s) *'}} </strong></label>
                                <app-uploader-files [mode]="main.modeForm!"></app-uploader-files>
                            </div>
                        </div>
                    </form>
                    <div class="flex justify-content-between mt-3">
                        <button pButton label="Atrás" icon="pi pi-arrow-left" (click)="prevStep()"></button>
                        <p-button *ngIf="main.modeForm === 'create' || main.modeForm === 'edit'"
                            [label]="main.modeForm === 'edit' ? 'Actualizar' : 'Agregar'" icon="pi pi-check"
                            styleClass="mr-2 p-button-success" [disabled]="form.stateForm === 'INVALID'"
                            (click)="submit()">
                        </p-button>
                    </div>
                </p-panel>

                <p-panel header="Incluir mención a asignatura(s)" *ngIf="form.activeTab === 4">
                    <form [formGroup]="form.fbForm">
                        <div class="flex">

                            <div class="flex-grow-1 flex-shrink-1 flex align-items-start justify-content-center w-full">
                                <p-table
                                    #dt7    
                                    [value]="main.menciones_form_incluir"
                                    [globalFilterFields]="['nombre_mencion', 'descripcion_mencion', 'mencion_rexe', 'fecha_creacion']"
                                    [scrollable]="true"
                                    [rowHover]="true"
                                    selectionMode="single"
                                    scrollHeight="350px"
                                    dataKey="cod_mencion"
                                    class="w-full"
                                    [(selection)]="table.selectedMencionesRows"
                                    (selectionChange)="selectMenciones($event)" 
                                >            
                                    
                                    <ng-template pTemplate="caption">
                                        <div class="flex flex-wrap flex-column sm:flex-row justify-content-center align-items-center">
                                            <p-button
                                                *ngIf="table.selectedMencionesRows.length !== 0"
                                                label="Deseleccionar"
                                                icon="pi pi-times"
                                                styleClass="p-button-danger p-button-outlined"
                                                (click)="clearTableMenciones(); "
                                            ></p-button>
                                            <div class="flex m-1">
                                                <span class="p-input-icon-left">
                                                <i class="pi pi-search"></i>
                                                <input #inputAsignatura pInputText type="text" placeholder="Buscar..." (input)="dt7.filterGlobal($any($event.target).value, 'contains')" />
                                                </span>
                                            </div>
                                            <p-button 
                                                styleClass="p-button-text p-button-sm " 
                                                icon="pi pi-filter-slash" 
                                                pTooltip="Limpiar filtros" 
                                                (click)="inputAsignatura.value = ''; dt7.filterGlobal('', 'contains') ">
                                            </p-button>
                                        </div>
                                    </ng-template>

                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th style="width: 2rem"></th>
                                            <th>Mención</th>
                                        </tr>
                                    </ng-template>
            
                                    <ng-template pTemplate="body" let-data>
                                        <tr>
                                            <td><p-tableRadioButton [value]="data"></p-tableRadioButton></td>
                                            <td>
                                                <span> {{data.nombre_mencion}} </span> <br>
                                                <span style="font-size: 0.8rem;">
                                                    <strong>REXE:</strong> {{data.mencion_rexe}} <br>
                                                    <strong>ESTADO:</strong> {{data.vigencia ? 'Vigente' : 'No vigente'}} <br>
                                                    <strong>FECHA CREACIÓN:</strong> {{data.fecha_creacion}} 
                                                </span>
                                            </td>
                                        </tr>
                                    </ng-template>
            
                                    <ng-template pTemplate="emptymessage">
                                        <tr>
                                            <td [attr.colspan]="2">Sin registros</td>
                                        </tr>
                                    </ng-template>
                                    
                                </p-table>
                            </div>

                            <div class="flex-shrink-0 flex flex-column align-items-center justify-content-center w-auto mx-2">
                                <span>Incluir a </span>
                                <i class="pi pi-arrow-right" style="font-size: 2rem; color:#6c757d"></i>
                            </div>

                            <div class="flex-grow-1 flex-shrink-1 flex align-items-start justify-content-center w-full">
                                <p-treeTable
                                    #dt8    
                                    [value]="main.asignaturas"
                                    [columns]="table.cols_asignatura"
                                    [globalFilterFields]="['nombre_asignatura_completa']"
                                    [scrollable]="true"
                                    [rowHover]="true"
                                    selectionMode="checkbox"
                                    scrollHeight="350px"
                                    dataKey="key"
                                    [(selectionKeys)]="table.selectedAsignaturaRows" 
                                    (selectionKeysChange)="selectAsignatura($event)"
                                >            
                                    <ng-template pTemplate="caption">
                                        <div class="flex flex-wrap flex-column sm:flex-row justify-content-center align-items-center">
                                            <div class="flex flex-row flex-wrap align-items-center">
                                                <p-button
                                                    *ngIf="form.fbForm.get('asignaturas')?.value.length !== 0 && main.modeForm !== 'show'"
                                                    label="Deseleccionar ({{ form.fbForm.get('asignaturas')?.value.length }})"
                                                    icon="pi pi-times"
                                                    styleClass="p-button-danger p-button-outlined"
                                                    (click)="clearTableAsignatura(); dt8.toggleNodesWithCheckbox($event, false)"
                                                ></p-button>
                                                <div class="flex m-1">
                                                    <span class="p-input-icon-left">
                                                    <i class="pi pi-search"></i>
                                                    <input #inputAsignatura pInputText type="text" placeholder="Buscar..." (input)="dt8.filterGlobal($any($event.target).value, 'contains')" />
                                                    </span>
                                                </div>
                                                <p-button 
                                                    styleClass="p-button-text p-button-sm " 
                                                    icon="pi pi-filter-slash" 
                                                    pTooltip="Limpiar filtros" 
                                                    (click)="inputAsignatura.value = ''; dt8.filterGlobal('', 'contains') ">
                                                </p-button>
                                            </div>
                                            <div class="flex estado-badge-doc icon-leyenda" pTooltip="Leyenda de iconos" tooltipPosition="bottom">
                                                <span class="icon-badge"><i class="pi pi-chevron-right"></i></span>
                                                <span class="mx-1 font-light">ver temas</span>
                                            </div>
                                        </div>
                                    </ng-template>   

                                    <ng-template pTemplate="header" let-columns>
                                        <tr>
                                            <th style="width: 2rem"></th>
                                            <th style="width: 2rem"></th>
                                            <th *ngFor="let col of columns">
                                                {{ col.header }}
                                            </th>
                                        </tr>
                                    </ng-template>
            
                                    <ng-template pTemplate="body" let-rowNode let-rowData="rowData" let-columns="columns">
                                        <tr [ttRow]="rowNode" [ttSelectableRow]="rowNode">
                                            <td *ngFor="let col of columns; let i = index">
                                                <p-treeTableToggler [rowNode]="rowNode" *ngIf="i === 0" />
                                                <p-treeTableCheckbox [disabled]="main.modeForm === 'show'" [value]="rowNode" *ngIf="i === 0" />
                                                <span class="truncate" style="font-size: 0.8rem;">
                                                    {{ rowData[col.field] }}
                                                </span>
                                            </td>
                                        </tr>
                                    </ng-template>
            
                                    <ng-template pTemplate="emptymessage">
                                        <tr>
                                            <td [attr.colspan]="2">Sin registros</td>
                                        </tr>
                                    </ng-template>
                                    
                                </p-treeTable>
                            </div>

                        </div>
                    </form>
                    <div class="flex justify-content-end mt-3">
                        <p-button *ngIf="main.modeForm === 'create' || main.modeForm === 'edit'"
                            label="Incluir" icon="pi pi-check"
                            styleClass="mr-2 p-button-success" [disabled]="form.stateForm === 'INVALID'"
                            (click)="submit()">
                        </p-button>
                    </div>
                </p-panel>
            </div>
        </div>
    </div>

    <div footer>
        <p-button label="Cerrar" icon="pi pi-times" styleClass="p-button-sm p-button-secondary mr-2" (click)="main.dialogForm = false" [text]="true"></p-button>
    </div>

</app-dialog>